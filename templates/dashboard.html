<!DOCTYPE html>
<html lang="it" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>Rogue AP Defense System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', monospace; }
        .card { border: 1px solid #333; background-color: #1e1e1e; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .btn-hack { background-color: #d63384; color: white; border: none; }
        .btn-hack:hover { background-color: #a82365; color: white; }
        .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; }
        .status-active { background-color: #00ff00; box-shadow: 0 0 5px #00ff00; }
        .log-console { 
            background-color: #000; 
            color: #00ff00; 
            font-family: 'Courier New', courier; 
            height: 300px; 
            overflow-y: scroll; 
            padding: 10px;
            border: 1px solid #444;
        }
        .alert-item { border-bottom: 1px solid #333; padding: 5px 0; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark border-bottom border-secondary mb-4">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1"><i class="fas fa-wifi"></i> ROGUE AP // SENTINEL</span>
    </div>
</nav>

<div class="container">
    <div class="row">
        <div class="col-md-5">
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <i class="fas fa-broadcast-tower"></i> Attack Simulator
                </div>
                <div class="card-body">
                    <form id="simForm">
                        <div class="mb-3">
                            <label>Target SSID</label>
                            <input type="text" class="form-control" id="ssid" value="FreeWiFi_Guest">
                        </div>
                        <div class="mb-3">
                            <label>Spoofed BSSID</label>
                            <input type="text" class="form-control" id="bssid" value="00:11:22:33:44:55">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Channel</label>
                            <input type="number" class="form-control" id="channel" value="6" min="1" max="14" placeholder="1-14">
                        </div>
                        <div class="mb-3">
                            <label>Beacon Interval (s)</label>
                            <input type="number" step="0.1" class="form-control" id="interval" value="0.1">
                        </div>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-hack" onclick="startSim()">
                                <i class="fas fa-play"></i> INJECT BEACONS
                            </button>
                            <button type="button" class="btn btn-outline-light" onclick="stopSim()">
                                <i class="fas fa-stop"></i> STOP
                            </button>
                        </div>
                    </form>
                    <div class="mt-3 text-center">
                        Status: <span id="simStatus" class="text-muted">IDLE</span>
                        <span id="simDot" class="status-dot"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-radar"></i> Live Detection Engine</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="detectSwitch" onchange="toggleDetector()">
                        <label class="form-check-label" for="detectSwitch">Active Scanning</label>
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Real-time Threat Log</h6>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearLogs()" title="Pulisci Log">
                            <i class="fas fa-trash-alt"></i> Pulisci
                        </button>
                    </div>
                    <div class="log-console" id="logConsole">
                        <div>[SYSTEM] System initialized... waiting for traffic.</div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-6">
                    <div class="card p-3 text-center">
                        <h3 id="alertCount">0</h3>
                        <small class="text-muted">Threats Detected</small>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card p-3 text-center">
                        <h3>Monitor</h3>
                        <small class="text-muted">Interface Mode</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let lastAlertCount = 0;
    let isInjecting = false;

    async function startSim() {
        // Previeni click multipli
        if(isInjecting) {
            alert("Attacco già in corso!");
            return;
        }

        const ssid = document.getElementById('ssid').value;
        const bssid = document.getElementById('bssid').value;
        const channel = document.getElementById('channel').value;
        const interval = document.getElementById('interval').value;

        // Validazione
        if(!ssid || !bssid) {
            alert("Compila SSID e BSSID!");
            return;
        }

        try {
            const response = await fetch('/api/start_sim', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ssid, bssid, channel, interval})
            });
            const data = await response.json();
            
            if(data.error) {
                alert(data.status);
                return;
            }
            
            isInjecting = true;
            document.getElementById('simStatus').innerText = "INJECTING...";
            document.getElementById('simStatus').className = "text-danger fw-bold";
            document.getElementById('simDot').classList.add('status-active');
            
            console.log(`[FRONTEND] Injection avviata: ${ssid} (${bssid}) - Channel ${channel}`);
        } catch(error) {
            console.error("Errore start_sim:", error);
            alert("Errore nell'avvio dell'attacco");
        }
    }

    async function stopSim() {
        try {
            await fetch('/api/stop_sim', {method: 'POST'});
            isInjecting = false;
            document.getElementById('simStatus').innerText = "IDLE";
            document.getElementById('simStatus').className = "text-muted";
            document.getElementById('simDot').classList.remove('status-active');
            
            console.log("[FRONTEND] Injection fermata");
        } catch(error) {
            console.error("Errore stop_sim:", error);
        }
    }

    async function toggleDetector() {
        const isChecked = document.getElementById('detectSwitch').checked;
        
        try {
            const response = await fetch('/api/toggle_detector', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({status: isChecked ? 'on' : 'off'})
            });
            const data = await response.json();
            
            console.log(`[FRONTEND] Detector ${isChecked ? 'ATTIVATO' : 'DISATTIVATO'}`);
            
            // Aggiorna il display
            updateAlertDisplay();
        } catch(error) {
            console.error("Errore toggle_detector:", error);
        }
    }

    async function updateAlertDisplay() {
        try {
            const response = await fetch('/api/get_alerts');
            const data = await response.json();
            const consoleDiv = document.getElementById('logConsole');
            const countDiv = document.getElementById('alertCount');

            // Debug
            if(data.queue_size > 0 || data.aps_tracked > 0) {
                console.log(`[DEBUG] Queue: ${data.queue_size}, AP tracciati: ${data.aps_tracked}, Alert: ${data.alerts.length}`);
            }

            // Aggiorna sempre il display
            consoleDiv.innerHTML = "";
            
            if(data.alerts && data.alerts.length > 0) {
                // Mostra alert
                data.alerts.forEach(alert => {
                    const line = `<div class="alert-item" style="color: #ff4444; font-family: monospace; margin: 3px 0; padding: 2px 5px; border-left: 3px solid #ff4444;">
                                    ${alert}
                                  </div>`;
                    consoleDiv.innerHTML += line;
                });
                countDiv.innerText = data.alerts.length;
                
                //if(data.alerts.length > lastAlertCount) {
                //}
                //lastAlertCount = data.alerts.length;
                
            } else {
                // Mostra stato
                if(data.is_scanning) {
                    if(data.is_injecting) {
                        consoleDiv.innerHTML = '<div style="color: #4CAF50; font-style: italic; padding: 5px;"> Detector attivo - In attesa di rilevamenti...</div>';
                    } else {
                        consoleDiv.innerHTML = '<div style="color: #888; font-style: italic; padding: 5px;"> Detector attivo - Nessuna injection in corso</div>';
                    }
                } else {
                    consoleDiv.innerHTML = '<div style="color: #888; font-style: italic; padding: 5px;"> Detector disattivato</div>';
                }
                countDiv.innerText = "0";
                lastAlertCount = 0;
            }
            
            // Scroll automatico
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            
            // Aggiorna stato injection (sincronizza con backend)
            isInjecting = data.is_injecting;
            
        } catch (error) {
            console.error("Errore nel recupero alert:", error);
            document.getElementById('logConsole').innerHTML = 
                '<div style="color: #ff4444;"> Errore di connessione al server</div>';
        }
    }

    // Polling più affidabile
    setInterval(updateAlertDisplay, 800); 

    async function clearLogs() {
        try {
            await fetch('/api/clear_alerts', { method: 'POST' });
            console.log("[FRONTEND] Log puliti - Il tracking continua");
            
            // Aggiorna immediatamente
            setTimeout(updateAlertDisplay, 100);
        } catch(error) {
            console.error("Errore clear_logs:", error);
        }
    }

    // Init al caricamento
    document.addEventListener('DOMContentLoaded', function() {
        console.log("[FRONTEND] Dashboard caricata");
        updateAlertDisplay();
    });
</script>




</body>
</html>
